import os
import pickle
from collections import OrderedDict

from dassl.data.datasets import DATASET_REGISTRY, Datum, DatasetBase
from dassl.utils import listdir_nohidden, mkdir_if_missing

from .oxford_pets import OxfordPets


@DATASET_REGISTRY.register()
class ImageNet(DatasetBase):
    SUPERCLASS_MAPPING = {
        "tench": "fish",
        "goldfish": "fish",
        "great white shark": "fish",
        "tiger shark": "fish",
        "electric ray": "fish",
        "stingray": "fish",
        "hen": "bird",
        "ostrich": "bird",
        "brambling": "bird",
        "goldfinch": "bird",
        "house finch": "bird",
        "junco": "bird",
        "indigo bunting": "bird",
        "bulbul": "bird",
        "jay": "bird",
        "magpie": "bird",
        "chickadee": "bird",
        "bald eagle": "bird",
        "vulture": "bird",
        "great grey owl": "bird",
        "great egret": "bird",
        "ruffed grouse": "bird",
        "bittern bird": "bird",
        "white stork": "bird",
        "black stork": "bird",
        "flamingo": "bird",
        "kite (bird of prey)": "bird",
        "partridge": "bird",
        "spoonbill": "bird",
        "lorikeet": "bird",
        "sulphur-crested cockatoo": "bird",
        "oystercatcher": "bird",
        "goose": "bird",
        "peafowl": "bird",
        "hornbill": "bird",
        "king penguin": "bird",
        "rooster": "bird",
        "coucal": "bird",
        "common gallinule": "bird",
        "black grouse": "bird",
        "dunlin": "bird",
        "red-breasted merganser": "bird",
        "little blue heron": "bird",
        "jacamar": "bird",
        "ptarmigan": "bird",
        "albatross": "bird",
        "bee eater": "bird",
        "prairie grouse": "bird",
        "crane bird": "bird",
        "duck": "bird",
        "hummingbird": "bird",
        "black swan": "bird",
        "pelican": "bird",
        "toucan": "bird",
        "giant panda": "mammal",
        "red panda": "mammal",
        "guenon": "mammal",
        "langur": "mammal",
        "proboscis monkey": "mammal",
        "macaque": "mammal",
        "baboon": "mammal",
        "chimpanzee": "mammal",
        "orangutan": "mammal",
        "gorilla": "mammal",
        "Briard": "mammal",
        "Japanese Chin": "mammal",
        "gazelle": "mammal",
        "sea lion": "marine_life",
        "hartebeest": "mammal",
        "white-headed capuchin": "mammal",
        "wombat": "mammal",
        "red wolf or maned wolf": "mammal",
        "coyote": "mammal",
        "mongoose": "mammal",
        "marmoset": "mammal",
        "Great Pyrenees dog": "mammal",
        "St. Bernard": "mammal",
        "black-and-white colobus": "mammal",
        "siamang": "mammal",
        "warthog": "mammal",
        "sloth bear": "mammal",
        "pug": "mammal",
        "cottontail rabbit": "mammal",
        "marmot": "mammal",
        "snow leopard": "mammal",
        "bison": "mammal",
        "grey wolf": "mammal",
        "red fox": "mammal",
        "otter": "mammal",
        "ring-tailed lemur": "mammal",
        "indri": "mammal",
        "badger": "mammal",
        "meerkat": "mammal",
        "impala (antelope)": "mammal",
        "African bush elephant": "mammal",
        "hamster": "mammal",
        "beaver": "mammal",
        "zebra": "mammal",
        "lion": "mammal",
        "cougar": "mammal",
        "polar bear": "mammal",
        "brown bear": "mammal",
        "tiger": "mammal",
        "cheetah": "mammal",
        "leopard": "mammal",
        "jaguar": "mammal",
        "platypus": "mammal",
        "armadillo": "mammal",
        "gibbon": "mammal",
        "howler monkey": "mammal",
        "porcupine": "mammal",
        "three-toed sloth": "mammal",
        "wild boar": "mammal",
        "grey fox": "mammal",
        "Irish Terrier": "mammal",
        "Angora rabbit": "mammal",
        "dingo": "mammal",
        "Rottweiler": "mammal",
        "Siberian Husky": "mammal",
        "Golden Retriever": "mammal",
        "Great Dane": "mammal",
        "Border Collie": "mammal",
        "Australian Terrier": "mammal",
        "Samoyed": "mammal",
        "dugong": "mammal",
        "killer whale": "mammal",
        "Labrador Retriever": "miscellaneous",
        "Cocker Spaniel": "mammal",
        "hippopotamus": "mammal",
        "titi monkey": "mammal",
        "alligator lizard": "reptile",
        "Gila monster": "reptile",
        "Komodo dragon": "reptile",
        "American alligator": "reptile",
        "green mamba": "reptile",
        "smooth green snake": "reptile",
        "Carolina anole": "reptile",
        "night snake": "reptile",
        "kingsnake": "reptile",
        "water snake": "reptile",
        "vine snake": "reptile",
        "frilled-necked lizard": "reptile",
        "banded gecko": "object",
        "African rock python": "reptile",
        "boa constrictor": "reptile",
        "green iguana": "reptile",
        "eastern diamondback rattlesnake": "reptile",
        "Nile crocodile": "reptile",
        "spotted salamander": "amphibian",
        "axolotl": "amphibian",
        "tree frog": "amphibian",
        "newt": "amphibian",
        "fire salamander": "amphibian",
        "American bullfrog": "amphibian",
        "mud turtle": "amphibian",
        "ant": "insect",
        "bee": "insect",
        "cockroach": "insect",
        "dragonfly": "insect",
        "fly": "insect",
        "grasshopper": "insect",
        "ladybug": "insect",
        "tiger beetle": "insect",
        "lacewing": "insect",
        "yellow garden spider": "insect",
        "barn spider": "insect",
        "European garden spider": "insect",
        "tarantula": "insect",
        "harvestman": "insect",
        "dung beetle": "insect",
        "longhorn beetle": "insect",
        "praying mantis": "insect",
        "weevil": "insect",
        "stick insect": "insect",
        "red admiral butterfly": "insect",
        "monarch butterfly": "insect",
        "ringlet butterfly": "insect",
        "leaf beetle": "insect",
        "ground beetle": "insect",
        "cicada": "insect",
        "jellyfish": "marine_life",
        "sea anemone": "marine_life",
        "sea cucumber": "marine_life",
        "starfish": "marine_life",
        "clownfish": "marine_life",
        "lionfish": "marine_life",
        "sea snake": "marine_life",
        "loggerhead sea turtle": "marine_life",
        "leatherback sea turtle": "marine_life",
        "spiny lobster": "marine_life",
        "sea slug": "marine_life",
        "brain coral": "marine_life",
        "ring binder": "object",
        "tool kit": "object",
        "car mirror": "object",
        "binoculars": "object",
        "chain mail": "object",
        "candle": "object",
        "bookcase": "object",
        "cannon": "object",
        "bathtub": "object",
        "mobile phone": "object",
        "bucket": "object",
        "broom": "object",
        "chain": "object",
        "beaker": "object",
        "beer bottle": "miscellaneous",
        "beer glass": "object",
        "ballpoint pen": "object",
        "CD player": "object",
        "automated teller machine": "object",
        "bookstore": "object",
        "chiffonier": "object",
        "chainsaw": "object",
        "balloon": "vehicle",
        "bottle cap": "object",
        "basketball": "object",
        "barbell": "object",
        "wheelbarrow": "object",
        "storage chest": "object",
        "birdhouse": "object",
        "catamaran": "vehicle",
        "movie theater": "object",
        "barn": "object",
        "hunting bow": "object",
        "taxicab": "vehicle",
        "station wagon": "vehicle",
        "high-speed train": "vehicle",
        "aircraft carrier": "vehicle",
        "airliner": "vehicle",
        "tandem bicycle": "vehicle",
        "amphibious vehicle": "vehicle",
        "airship": "vehicle",
        "canoe": "vehicle",
        "accordion": "musical_instrument",
        "banjo": "musical_instrument",
        "cello": "musical_instrument",
        "bassoon": "musical_instrument",
        "acoustic guitar": "musical_instrument",
        "baby bib": "object",
        "apiary": "object",
        "Australian Kelpie": "mammal",
        "military hat (bearskin or shako)": "object",
        "French Bulldog": "mammal",
        "American black bear": "mammal",
        "cardigan": "object",
        "Australian Silky Terrier": "mammal",
        "weasel": "mammal",
        "balance beam": "object",
        "Dalmatian": "mammal",
        "Malinois": "mammal",
        "collie": "mammal",
        "Kuvasz": "mammal",
        "abacus": "object",
        "Tibetan Terrier": "mammal",
        "Weimaraner": "mammal",
        "Cardigan Welsh Corgi": "mammal",
        "Scottish Deerhound": "mammal",
        "Miniature Pinscher": "mammal",
        "Standard Poodle": "mammal",
        "Norwich Terrier": "mammal",
        "bikini": "object",
        "buckle": "object",
        "Airedale Terrier": "mammal",
        "Standard Schnauzer": "mammal",
        "bakery": "object",
        "Entlebucher Sennenhund": "mammal",
        "bolo tie": "object",
        "Miniature Poodle": "mammal",
        "gar fish": "marine_life",
        "Groenendael dog": "mammal",
        "husky": "mammal",
        "chiton": "marine_life",
        "Ibizan Hound": "mammal",
        "black-footed ferret": "mammal",
        "Saharan horned viper": "reptile",
        "Pembroke Welsh Corgi": "mammal",
        "barber chair": "object",
        "bassinet": "object",
        "trash can": "object",
        "Cairn Terrier": "mammal",
        "Tibetan Mastiff": "mammal",
        "poke bonnet": "object",
        "hammerhead shark": "marine_life",
        "worm snake": "reptile",
        "Irish Water Spaniel": "mammal",
        "tusker": "mammal",
        "butcher shop": "object",
        "macaw": "bird",
        "American dipper": "bird",
        "conch": "marine_life",
        "Chesapeake Bay Retriever": "mammal",
        "chain-link fence": "object",
        "crayfish": "marine_life",
        "Giant Schnauzer": "mammal",
        "cardboard box / carton": "object",
        "tabby cat": "mammal",
        "breakwater": "object",
        "Curly-coated Retriever": "mammal",
        "hare": "mammal",
        "arabian camel": "mammal",
        "cleaver": "object",
        "cassette": "object",
        "Boxer": "mammal",
        "Chow Chow": "mammal",
        "Maltese": "mammal",
        "sea urchin": "marine_life",
        "slug": "marine_life",
        "Chihuahua": "mammal",
        "bell or wind chime": "object",
        "analog clock": "object",
        "Scottish Terrier": "mammal",
        "Lakeland Terrier": "mammal",
        "Gordon Setter": "mammal",
        "Whippet": "mammal",
        "Keeshond": "mammal",
        "Papillon": "mammal",
        "Toy Poodle": "mammal",
        "bow tie": "object",
        "Irish Setter": "mammal",
        "bell tower": "object",
        "King Charles Spaniel": "mammal",
        "ambulance": "vehicle",
        "Old English Sheepdog": "mammal",
        "Welsh Springer Spaniel": "mammal",
        "ox": "mammal",
        "Shih Tzu": "mammal",
        "koala": "mammal",
        "Mexican hairless dog (xoloitzcuintli)": "mammal",
        "Schipperke": "mammal",
        "West Highland White Terrier": "mammal",
        "ruddy turnstone": "bird",
        "Border Terrier": "mammal",
        "nematode": "insect",
        "can opener": "object",
        "American lobster": "marine_life",
        "Bedlington Terrier": "mammal",
        "Staffordshire Bull Terrier": "mammal",
        "sturgeon": "marine_life",
        "guinea pig": "mammal",
        "Basset Hound": "mammal",
        "Sussex Spaniel": "mammal",
        "assault rifle": "object",
        "Bouvier des Flandres dog": "mammal",
        "Basenji": "mammal",
        "swimming cap": "object",
        "Shetland Sheepdog": "mammal",
        "bra": "object",
        "breastplate": "object",
        "silver salmon": "marine_life",
        "Lhasa Apso": "mammal",
        "Alaskan tundra wolf": "mammal",
        "Alaskan Malamute": "mammal",
        "car wheel": "object",
        "flatworm": "amphibian",
        "Otterhound": "mammal",
        "Afghan Hound": "mammal",
        "ram (adult male sheep)": "mammal",
        "triceratops": "object",
        "barometer": "object",
        "snail": "marine_life",
        "English Springer Spaniel": "mammal",
        "Clumber Spaniel": "mammal",
        "European polecat": "mammal",
        "Wire Fox Terrier": "mammal",
        "bulletproof vest": "object",
        "Italian Greyhound": "mammal",
        "bath towel": "object",
        "Black and Tan Coonhound": "mammal",
        "water buffalo": "mammal",
        "Alpine ibex": "mammal",
        "Pekingese": "mammal",
        "african grey parrot": "bird",
        "wolf spider": "insect",
        "Soft-coated Wheaten Terrier": "mammal",
        "Newfoundland dog": "mammal",
        "Affenpinscher": "mammal",
        "tiger cat": "mammal",
        "Bloodhound": "mammal",
        "German Shepherd Dog": "mammal",
        "snoek fish": "marine_life",
        "fox squirrel": "mammal",
        "skunk": "mammal",
        "china cabinet": "object",
        "Vizsla": "mammal",
        "centipede": "insect",
        "Miniature Schnauzer": "mammal",
        "lynx": "mammal",
        "Komondor": "mammal",
        "Appenzeller Sennenhund": "mammal",
        "desert grassland whiptail lizard": "reptile",
        "small white butterfly": "insect",
        "common squirrel monkey": "mammal",
        "Brittany dog": "mammal",
        "Boston Terrier": "mammal",
        "brussels griffon": "mammal",
        "common sorrel horse": "mammal",
        "borzoi": "mammal",
        "apron": "object",
        "English foxhound": "mammal",
        "gossamer-winged butterfly": "insect",
        "Arctic fox": "mammal",
        "kit fox": "mammal",
        "Bluetick Coonhound": "mammal",
        "American coot": "bird",
        "grey whale": "marine_life",
        "Treeing Walker Coonhound": "mammal",
        "Siamese cat": "mammal",
        "carousel": "object",
        "Kerry Blue Terrier": "mammal",
        "bobsleigh": "vehicle",
        "German Shorthaired Pointer": "mammal",
        "Egyptian Mau": "mammal",
        "Dobermann": "mammal",
        "abaya": "object",
        "mink": "mammal",
        "bustard": "bird",
        "Sealyham Terrier": "mammal",
        "baseball": "object",
        "Saluki": "mammal",
        "Yorkshire Terrier": "mammal",
        "pig": "mammal",
        "toy terrier": "mammal",
        "Beagle": "mammal",
        "Bullmastiff": "mammal",
        "lighthouse": "object",
        "English Setter": "mammal",
        "Rhodesian Ridgeback": "mammal",
        "isopod": "insect",
        "church": "object",
        "patas monkey": "mammal",
        "Greater Swiss Mountain Dog": "mammal",
        "Leonberger": "mammal",
        "Flat-Coated Retriever": "mammal",
        "altar": "object",
        "American Staffordshire Terrier": "mammal",
        "Norfolk Terrier": "mammal",
        "Band-Aid": "object",
        "southern black widow": "insect",
        "Dandie Dinmont Terrier": "mammal",
        "boathouse": "object",
        "dhole": "mammal",
        "scorpion": "insect",
        "barbershop": "object",
        "cauldron": "object",
        "limpkin": "bird",
        "bighorn sheep": "mammal",
        "terrapin": "reptile",
        "Geoffroy's spider monkey": "mammal",
        "Asian elephant": "mammal",
        "trilobite": "insect",
        "rhinoceros beetle": "insect",
        "tailed frog": "amphibian",
        "smooth newt": "amphibian",
        "eastern hog-nosed snake": "amphibian",
        "sidewinder rattlesnake": "reptile",
        "chameleon": "reptile",
        "Indian cobra": "reptile",
        "agama": "reptile",
        "garter snake": "reptile",
        "ring-necked snake": "reptile",
        "European green lizard": "reptile",
        "box turtle": "reptile",
        "chambered nautilus": "reptile",
        "llama": "mammal",
        "wallaby": "mammal",
        "echidna": "mammal",
        "African wild dog": "mammal",
        "hyena": "mammal",
        "Norwegian Elkhound": "mammal",
        "Redbone Coonhound": "mammal",
        "Irish Wolfhound": "mammal",
        "Pomeranian": "mammal",
        "Persian cat": "mammal",
        "Bernese Mountain Dog": "mammal",
        "common redshank": "bird",
        "quail": "bird",
        "American robin": "bird",
        "sulphur butterfly": "bird",
        "dowitcher": "bird",
        "fiddler crab": "insect",
        "damselfly": "insect",
        "cricket insect": "insect",
        "leafhopper": "insect",
        "tick": "insect",
        "pufferfish": "marine_life",
        "rock crab": "marine_life",
        "hermit crab": "marine_life",
        "eel": "marine_life",
        "Dungeness crab": "marine_life",
        "red king crab": "marine_life",
        "barrel": "object",
        "baluster / handrail": "object",
        "backpack": "object",
        "castle": "object",
        "academic gown": "object",
        "brass memorial plaque": "object",
        "rock beauty fish": "object",
        "Christmas stocking": "miscellaneous",
        "cassette player": "miscellaneous",
        
        "mountain": "geography",

    # Architecture
    "sliding door": "architecture",
    "thatched roof": "architecture",
    "through arch bridge": "architecture",
    "lakeshore": "architecture",
    "dome": "architecture",
    "minaret": "architecture",

    # Vehicles
    "sports car": "vehicle",
    "minibus": "vehicle",
    "bullock cart": "vehicle",
    "garbage truck": "vehicle",
    "school bus": "vehicle",
    "limousine": "vehicle",
    "space shuttle": "vehicle",
    "submarine": "vehicle",
    "pickup truck": "vehicle",
    "motorboat": "vehicle",
    "rickshaw": "vehicle",
    "electric locomotive": "vehicle",
    "semi-trailer truck": "vehicle",
    "railroad car": "vehicle",
    "container ship": "vehicle",
    "sailboat": "vehicle",

    # Clothing and Accessories
    "sweatshirt": "clothing_accessory",
    "one-piece bathing suit": "clothing_accessory",
    "hair clip": "clothing_accessory",
    "gown": "clothing_accessory",
    "stethoscope": "medical",
    "tights": "clothing_accessory",
    "trench coat": "clothing_accessory",
    "sombrero": "clothing_accessory",
    "crash helmet": "clothing_accessory",
    "pajamas": "clothing_accessory",
    "Windsor tie": "clothing_accessory",
    "lab coat": "clothing_accessory",
    "safety helmet": "clothing_accessory",
    "gloves": "clothing_accessory",
    "balaclava ski mask": "clothing_accessory",
    "cowboy hat": "clothing_accessory",
    "hoop skirt": "clothing_accessory",

    # Kitchenware
    "ladle": "kitchenware",
    "spatula": "kitchenware",
    "mixing bowl": "kitchenware",
    "soup bowl": "kitchenware",
    "tray": "kitchenware",

    # Tools
    "drumstick": "tool",
    "safety pin": "tool",
    "screw": "tool",
    "wrench": "tool",
    "shovel": "tool",
    "needle": "tool",
    "pliers": "tool",
    "sewing machine": "tool",
    "screwdriver": "tool",

    # Objects
    "shopping cart": "object",
    "umbrella": "object",
    "menu": "object",
    "parking meter": "object",
    "toilet paper": "object",
    "sundial": "object",
    "flagpole": "object",
    "folding chair": "furniture",
    "typewriter keyboard": "object",
    "magnetic compass": "object",
    "combination lock": "object",
    "pill bottle": "medical",
    "honeycomb": "object",
    "four-poster bed": "furniture",

    # Food
    "burrito": "food",
    "spaghetti squash": "food",
    "pineapple": "food",
    "cucumber": "food",
    "eggnog": "food",
    "mashed potatoes": "food",
    "carbonara": "food",
    "pizza": "food",
    "bagel": "food",
    "hot dog": "food",
    "cheeseburger": "food",

    # Musical Instruments
    "marimba": "musical_instrument",
    "flute": "musical_instrument",
    "pipe organ": "musical_instrument",
    "electric guitar": "musical_instrument",
    "harp": "musical_instrument",
    "trombone": "musical_instrument",
    "violin": "musical_instrument",
    "saxophone": "musical_instrument",
    "French horn": "musical_instrument",

    # Furniture
    "rocking chair": "furniture",
    "lampshade": "furniture",
    "dining table": "furniture",
    "couch": "furniture",
    "wardrobe": "furniture",

    # Toys
    "teddy bear": "toy",

    # Medical
    "stethoscope": "medical",
    "pill bottle": "medical",

    # Devices
    "digital clock": "device",
    "refrigerator": "device",
    "radio": "device",
    "desktop computer": "device",
    "microwave oven": "device",
    "electric fan": "device",
    "vacuum cleaner": "device",
    "laptop computer": "device",
    "tablet computer": "device",
    "projector": "device",

    # Architecture
    "thatched roof": "architecture",
    "through arch bridge": "architecture",
    "lakeshore": "architecture",
    "dome": "architecture",
    "minaret": "architecture",

    # Miscellaneous
    "umbrella": "object",
    "menu": "object",
    "sundial": "object",
    "flagpole": "object",
    "honeycomb": "object",
    "folding chair": "furniture",
    "shopping basket": "object",
    "weighing scale": "object",
    "rifle": "object",
    "Pickelhaube": "object",
    "joystick": "object",
    "bridegroom": "object",
    "military aircraft": "vehicle",
    "tent": "object",
    "water tower": "object",
    "missile": "object",
    "lifeboat": "vehicle",
    "ocrina": "musical_instrument",
    "tram": "vehicle",
    "paintbrush": "tool",
    "gas pump": "tool",
    "tractor": "vehicle",
    "airplane wing": "vehicle",
    "handkerchief": "object",
    "wallet": "object",
    "toy": "object",
    "pickle jar": "kitchenware",
    "tea kettle": "kitchenware",
    "wooden spoon": "kitchenware",
    "book": "object",
    "radio telescope": "scientific_instrument",
    "monitor": "device",
    "knot": "object",
    "maze": "object",
    "quilt": "furniture",
    "toaster": "device",
    "yurt": "architecture",
    "fireplace": "architecture",
    "grill": "kitchenware",
    "lantern": "light_source",
    "flashlight": "light_source",
    "manhole cover": "architecture",
    "stupa": "architecture",
    "coffee grinder": "device",
    "espresso machine": "kitchenware",
    "mousetrap": "tool",
    "wooden chair": "furniture",
    "fire extinguisher": "device",
    "oxygen mask": "medical",
    "volleyball": "sport",
    "cradle": "furniture",
    "puzzle": "toy",
    "snowmobile": "vehicle",
    "suit": "clothing_accessory",
    "microphone": "device",
    "ceramic plate": "kitchenware",
    "sculpture": "object",
    "pan flute": "musical instrument",
    "mop": "cleaning tool",
    "bubble": "natural phenomenon",
    "hourglass": "timekeeping device",
    "knee pad": "protective gear",
    "water jug": "kitchenware",
    "corn cob": "food",
    "grocery store": "place",
    "eraser": "stationery",
    "metal nail": "hardware",
    "wine bottle": "beverage container",
    "loupe magnifying glass": "optical tool",
    "stage": "place",
    "printer": "office equipment",
    "construction crane": "construction equipment",
    "lawn mower": "gardening tool",
    "digital watch": "timekeeping device",
    "doormat": "home accessory",
    "letter opener": "office tool",
    "agaric": "fungus",
    "tea cup": "kitchenware",
    "spiral or coil": "shape",
    "padlock": "security tool",
    "iPod": "electronic device",
    "velvet fabric": "material",
    "lighter": "ignition tool",
    "quill": "writing tool",
    "snowplow": "vehicle",
    "half-track": "vehicle",
    "pomegranate": "food",
    "scarf": "clothing accessory",
    "window screen": "home accessory",
    "tobacco shop": "place",
    "rain barrel": "outdoor equipment",
    "vase": "decorative item",
    "cowboy boot": "footwear",
    "torch": "lighting tool",
    "dishcloth": "cleaning tool",
    "beach": "natural place",
    "forklift": "vehicle",
    "harmonica": "musical instrument",
    "wall clock": "timekeeping device",
    "football helmet": "protective gear",
    "prison": "place",
    "sock": "clothing",
    "baguette": "food",
    "hay": "agriculture",
    "radiator grille": "vehicle part",
    "picket fence": "outdoor equipment",
    "golf cart": "vehicle",
    "medicine cabinet": "furniture",
    "rose hip": "plant part",
    "notebook computer": "electronic device",
    "mushroom": "fungus",
    "geyser": "natural phenomenon",
    "ping-pong ball": "sports equipment",
    "overskirt": "clothing",
    "drum": "musical instrument",
    "T-shirt": "clothing",
    "infant bed": "furniture",
    "plunger": "cleaning tool",
    "website": "digital platform",
    "hot pot": "kitchenware",
    "soccer ball": "sports equipment",
    "messenger bag": "bag",
    "block plane": "woodworking tool",
    "parallel bars": "sports equipment",
    "holster": "accessory",
    "stove": "kitchen appliance",
    "shield": "protective gear",
    "pole": "structural object",
    "popsicle": "food",
    "lipstick": "cosmetic",
    "broccoli": "food",
    "slot machine": "entertainment",
    "dishwasher": "kitchen appliance",
    "stretcher": "medical equipment",
    "coral reef": "natural phenomenon",
    "dock": "place",
    "teapot": "kitchenware",
    "electrical switch": "hardware",
    "candy store": "place",
    "potter's wheel": "craft tool",
    "comic book": "literature",
    "steam locomotive": "vehicle",
    "throne": "furniture",
    "maypole": "cultural item",
    "measuring cup": "kitchenware",
    "paddle wheel": "vehicle part",
    "shower cap": "clothing accessory",
    "split-rail fence": "outdoor equipment",
    "espresso": "beverage",
    "plastic bag": "container",
    "remote control": "electronic device",
    "prayer rug": "cultural item",
    "parachute": "sports equipment",
    "ocean liner": "vehicle",
    "graduation cap": "clothing accessory",
    "slip-on shoe": "footwear",
    "planetarium": "place",
    "pencil sharpener": "stationery",
    "reflex camera": "electronic device",
    "stopwatch": "timekeeping device",
    "soda bottle": "beverage container",
    "red wine": "beverage",
    "syringe": "medical equipment",
    "spindle": "tool",
    "entertainment center": "furniture",
    "freight car": "vehicle",
    "yellow lady's slipper": "plant",
    "wool": "material",
    "goblet": "kitchenware",
    "drink pitcher": "kitchenware",
    "steel drum": "musical instrument",
    "toilet seat": "bathroom accessory",
    "park bench": "furniture",
    "mailbox": "outdoor equipment",
    "dumbbell": "sports equipment",
    "rugby ball": "sports equipment",
    "swim trunks / shorts": "clothing",
    "hatchet": "tool",
    "horse chestnut seed": "plant part",
    "vaulted or arched ceiling": "architectural feature",
    "tricycle": "vehicle",
    "hard disk drive": "electronic device",
    "CRT monitor": "electronic device",
    "payphone": "communication device",
    "power drill": "tool",
    "stone wall": "architectural feature",
    "triumphal arch": "architectural feature",
    "tape player": "electronic device",
    "hamper": "furniture",
    "hair wig": "accessory",
    "race car": "vehicle",
    "bolete": "fungus",
    "desk": "furniture",
    "kimono": "clothing",
    "Dutch oven": "kitchenware",
    "hair dryer": "electronic device",
    "cabbage": "food",
    "baseball player": "person",
    "military uniform": "clothing",
    "hair spray": "cosmetic",
    "safe": "security tool",
    "greenhouse": "place",
    "ford model t": "vehicle",
    "mosquito net": "protective gear",
    "waffle iron": "kitchen appliance",
    "restaurant": "place",
    "mosque": "place",
    "cliff dwelling": "architectural feature",
    "sleeping bag": "camping gear",
    "rotary dial telephone": "communication device",
    "milk can": "container",
    "scabbard": "accessory",
    "sink": "bathroom accessory",
    "obelisk": "architectural feature",
    "sandbar": "natural phenomenon",
    "threshing machine": "agriculture tool",
    "fur coat": "clothing",
    "patio": "architectural feature",
    "computer mouse": "electronic device",
    "clogs": "footwear",
    "totem pole": "cultural item",
    "cloak": "clothing",
    "poncho": "clothing",
    "cherimoya (custard apple)": "food",
    "Petri dish": "scientific tool",
    "turnstile": "place",
    "meatloaf": "food",
    "lens cap": "accessory",
    "ocarina": "musical instrument",
    "plant pot": "gardening tool",
    "promontory": "natural phenomenon",
    "gong": "musical instrument",
    "stinkhorn mushroom": "fungus",
    "trolleybus": "vehicle",
    "oil filter": "vehicle part",
    "crate": "container",
    "jackfruit": "food",
    "mortar and pestle": "kitchen tool",
    "hot tub": "bathroom accessory",
    "traffic or street sign": "outdoor equipment",
    "Crock Pot": "kitchen appliance",
    "pencil case": "stationery",
    "butternut squash": "food",
    "valley": "natural place",
    "bell pepper": "food",
    "matchstick": "ignition tool",
    "megalith": "architectural feature",
    "sunglasses": "clothing accessory",
    "crossword": "game",
    "vending machine": "appliance",
    "odometer": "vehicle part",
    "horse-drawn vehicle": "vehicle",
    "pot pie": "food",
    "gondola": "vehicle",
    "water bottle": "beverage container",
    "dough": "food",
    "golf ball": "sports equipment",
    "fig": "food",
    "Polaroid camera": "electronic device",
    "revolver": "weapon",
    "salt shaker": "kitchenware",
    "cuirass": "armor",
    "modem": "electronic device",
    "purse": "bag",
    "hen of the woods mushroom": "fungus",
    "paddle": "sports equipment",
    "farm plow": "agriculture tool",
    "corn": "food",
    "tank": "vehicle",
    "ice cream": "food",
    "vestment": "clothing",
    "artichoke": "food",
    "scoreboard": "sports equipment",
    "punching bag": "sports equipment",
    "whistle": "sports equipment",
    "cardoon": "food",
    "crutch": "medical equipment",
    "gyromitra": "fungus",
    "hammer": "tool",
    "muzzle": "accessory",
    "grand piano": "musical instrument",
    "dam": "architectural feature",
    "monastery": "place",
    "recreational vehicle": "vehicle",
    "rapeseed": "plant",
    "fountain": "architectural feature",
    "piggy bank": "container",
    "consomme": "food",
    "zucchini": "food",
    "trifle": "food",
    "sarong": "clothing",
    "front curtain": "home accessory",
    "cliff": "natural phenomenon",
    "dust jacket": "book accessory",
    "necklace": "jewelry",
    "sneaker": "footwear",
    "pirate ship": "vehicle",
    "coffeemaker": "kitchen appliance",
    "paper towel": "cleaning tool",
    "feather boa": "clothing accessory",
    "croquet ball": "sports equipment",
    "tennis ball": "sports equipment",
    "vespa": "vehicle",
    "combine harvester": "agriculture tool",
    "tow truck": "vehicle",
    "pretzel": "food",
    "soap dispenser": "bathroom accessory",
    "spider web": "natural phenomenon",
    "daisy": "plant",
    "maraca": "musical instrument",
    "acorn squash": "food",
    "spotlight": "lighting tool",
    "pier": "architectural feature",
    "gymnastic horizontal bar": "sports equipment",
    "swing": "sports equipment",
    "minivan": "vehicle",
    "guacamole": "food",
    "solar thermal collector": "energy device",
    "pillow": "bedding accessory",
    "slide rule": "scientific tool",
    "coffee mug": "kitchenware",
    "shower curtain": "bathroom accessory",
    "lemon": "food",
    "chocolate syrup": "food",
    "strainer": "kitchenware",
    "library": "place",
    "shipwreck": "place",
    "lotion": "cosmetic",
    "wok": "kitchenware",
    "hand-held computer": "electronic device",
    "mobile home": "place",
    "product packet / packaging": "container",
    "baby pacifier": "baby accessory",
    "coral fungus": "fungus",
    "music speaker": "electronic device",
    "rotisserie": "kitchen appliance",
    "ski": "sports equipment",
    "banana": "food",
    "fire truck": "vehicle",
    "suspension bridge": "architectural feature",
    "photocopier": "office equipment",
    "hook": "tool",
    "frying pan": "kitchenware",
    "keyboard space bar": "computer part",
    "plectrum": "musical instrument accessory",
    "dog sled": "vehicle",
    "pedestal": "furniture",
    "gas mask or respirator": "protective gear",
    "tile roof": "architectural feature",
    "pool table": "sports equipment",
    "fountain pen": "writing tool",
    "go-kart": "vehicle",
    "scuba diver": "person",
    "shoji screen / room divider": "furniture",
    "acorn": "plant part",
    "seat belt": "safety equipment",
    "jigsaw puzzle": "game",
    "computer keyboard": "electronic device",
    "fireboat": "vehicle",
    "toy store": "place",
    "cocktail shaker": "kitchenware",
    "earth star fungus": "fungus",
    "schooner": "vehicle",
    "envelope": "stationery",
    "pinwheel": "toy",
    "cauliflower": "food",
    "home theater": "electronic device",
    "plate": "kitchenware",
    "television": "electronic device",
    "drilling rig": "construction equipment",
    "moped": "vehicle",
    "shoe store": "place",
    "space heater": "home appliance",
    "clothes iron": "home appliance",
    "trimaran": "vehicle",
    "jeans": "clothing",
    "fishing casting reel": "fishing gear",
    "orange": "food",
    "table lamp": "lighting tool",
    "viaduct": "architectural feature",
    "miniskirt": "clothing",
    "oscilloscope": "scientific tool",
    "Granny Smith apple": "food",
    "jeep": "vehicle",
    "tripod": "camera accessory",
    "unicycle": "vehicle",
    "traffic light": "outdoor equipment",
    "mitten": "clothing",
    "snorkel": "sports equipment",
    "perfume": "cosmetic",
    "neck brace": "medical equipment",
    "racket": "sports equipment",
    "ruler measuring stick": "stationery",
    "diaper": "baby accessory",
    "volcano": "natural phenomenon",
    "thimble": "sewing tool",
    "mountain bike": "vehicle",
    "disc brake": "vehicle part",
    "hockey puck": "sports equipment",
    "sunscreen": "cosmetic",
    "carved pumpkin": "decorative item",
    "mask": "accessory",
    "police van": "vehicle",
    "upright piano": "musical instrument",
    "strawberry": "food",
    "convertible": "vehicle",
    "moving van": "vehicle",
    "fire screen": "furniture",
    "plate rack": "kitchenware",
    "cornet": "musical instrument",
    "face powder": "cosmetic",
    "sandal": "footwear",
    "palace": "place",
    "window shade": "home accessory",
    "oboe": "musical instrument",
    "corkscrew": "kitchenware",
    "radiator": "home appliance",
    "sawmill": "construction equipment",
    "washing machine": "home appliance",
    "whiskey jug": "kitchenware",
    "filing cabinet": "office equipment",
    "guillotine": "tool"

    }

    dataset_dir = "imagenet"

    def __init__(self, cfg):
        root = os.path.abspath(os.path.expanduser(cfg.DATASET.ROOT))
        self.dataset_dir = os.path.join(root, self.dataset_dir)
        self.image_dir = os.path.join(self.dataset_dir, "images")
        self.preprocessed = os.path.join(self.dataset_dir, "preprocessed.pkl")
        self.split_fewshot_dir = os.path.join(self.dataset_dir, "split_fewshot")
        mkdir_if_missing(self.split_fewshot_dir)

        if os.path.exists(self.preprocessed):
            with open(self.preprocessed, "rb") as f:
                preprocessed = pickle.load(f)
                train = preprocessed["train"]
                test = preprocessed["test"]
            print(f"Loaded preprocessed data: train={len(train)}, test={len(test)}") # test 0 문제  ^^
        else:
            print("Preprocessed file not found. Reading raw data...")
            text_file = os.path.join(self.dataset_dir, "classnames.txt")
            if not os.path.exists(text_file):
                raise FileNotFoundError(f"Classnames file not found at {text_file}")
            classnames = self.read_classnames(text_file)
            print(f"Classnames: {list(classnames.keys())[:5]} ...")
            train = self.read_data(classnames, "train")
            print(f"Loaded train data: {len(train)} items")
            # Follow standard practice to perform evaluation on the val set
            # Also used as the val set (so evaluate the last-step model)
            test = self.read_data(classnames, "val")
            print(f"Loaded test data: {len(test)} items")

            preprocessed = {"train": train, "test": test}
            with open(self.preprocessed, "wb") as f:
                pickle.dump(preprocessed, f, protocol=pickle.HIGHEST_PROTOCOL)
            print(f"Saved preprocessed data to {self.preprocessed}")

        num_shots = cfg.DATASET.NUM_SHOTS
        if num_shots >= 1:
            seed = cfg.SEED
            preprocessed = os.path.join(self.split_fewshot_dir, f"shot_{num_shots}-seed_{seed}.pkl")
            
            if os.path.exists(preprocessed):
                print(f"Loading preprocessed few-shot data from {preprocessed}")
                with open(preprocessed, "rb") as file:
                    data = pickle.load(file)
                    train = data["train"]
            else:
                train = self.generate_fewshot_dataset(train, num_shots=num_shots)
                data = {"train": train}
                print(f"Saving preprocessed few-shot data to {preprocessed}")
                with open(preprocessed, "wb") as file:
                    pickle.dump(data, file, protocol=pickle.HIGHEST_PROTOCOL)

        subsample = cfg.DATASET.SUBSAMPLE_CLASSES
        print(f"\t\t\tBefore subsample: {len(set(d.label for d in train))}")
        train, test = OxfordPets.subsample_classes(train, test, subsample=subsample)
        print(f"\t\t\tAfter subsample: {len(set(d.label for d in train))}")

        super().__init__(train_x=train, val=test, test=test)
    
    def __getitem__(self, index):
        item = super().__getitem__(index)
        superclass = self.SUPERCLASS_MAPPING.get(item.classname, "object")
        return item._replace(superclass=superclass)

    @staticmethod
    def read_classnames(text_file):
        """Return a dictionary containing
        key-value pairs of <folder name>: <class name>.
        """
        classnames = OrderedDict()
        with open(text_file, "r") as f:
            lines = f.readlines()
            for line in lines:
                line = line.strip().split(" ")
                folder = line[0]
                classname = " ".join(line[1:])
                classnames[folder] = classname
        return classnames

    def read_data(self, classnames, split_dir):
        split_dir = os.path.join(self.image_dir, split_dir)
        folders = sorted(f.name for f in os.scandir(split_dir) if f.is_dir())
        print(f"Folders (Classes): {folders}, Total Classes: {len(folders)}")

        items = []

        for label, folder in enumerate(folders):
            imnames = listdir_nohidden(os.path.join(split_dir, folder))
            classname = classnames[folder]
            for imname in imnames:
                impath = os.path.join(split_dir, folder, imname)
                item = Datum(impath=impath, label=label, classname=classname)
                items.append(item)

        return items
